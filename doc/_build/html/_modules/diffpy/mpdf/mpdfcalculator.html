<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>diffpy.mpdf.mpdfcalculator &mdash; diffpy.mpdf 0.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="diffpy.mpdf 0.0.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for diffpy.mpdf.mpdfcalculator</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1"># diffpy.mpdf       by Billinge Group</span>
<span class="c1">#                     Simon J. L. Billinge sb2896@columbia.edu</span>
<span class="c1">#                     (c) 2016 trustees of Columbia University in the City of</span>
<span class="c1">#                           New York.</span>
<span class="c1">#                      All rights reserved</span>
<span class="c1">#</span>
<span class="c1"># File coded by:    Benjamin Frandsen</span>
<span class="c1">#</span>
<span class="c1"># See AUTHORS.txt for a list of people who contributed.</span>
<span class="c1"># See LICENSE.txt for license information.</span>
<span class="c1">#</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;functions and classes to perform mPDF calculations&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">fftconvolve</span>

<div class="viewcode-block" id="jCalc"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.jCalc">[docs]</a><span class="k">def</span> <span class="nf">jCalc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2394</span><span class="p">,</span> <span class="mf">26.038</span><span class="p">,</span> <span class="mf">0.4727</span><span class="p">,</span> <span class="mf">12.1375</span><span class="p">,</span> <span class="mf">0.3065</span><span class="p">,</span> <span class="mf">3.0939</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01906</span><span class="p">],</span>
          <span class="n">j2</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the magnetic form factor j0.</span>

<span class="sd">    This method for calculating the magnetic form factor is based on the</span>
<span class="sd">    approximate empirical forms based on the tables by Brown, consisting of</span>
<span class="sd">    the sum of 3 Gaussians and a constant.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (numpy array): 1-d grid of momentum transfer on which the form</span>
<span class="sd">            factor is to be computed</span>
<span class="sd">        params (python list): provides the 7 numerical coefficients. The</span>
<span class="sd">            default is an average form factor of 3d j0 approximations.</span>
<span class="sd">        j2 (boolean): if True, calculate the j2 approximation for orbital</span>
<span class="sd">            angular momentum contributions</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy array with same shape as q giving the magnetic form factor j0 or j2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">D</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">if</span> <span class="n">j2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">C</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">D</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mf">4.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">C</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">D</span></div>

<div class="viewcode-block" id="cv"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.cv">[docs]</a><span class="k">def</span> <span class="nf">cv</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform the convolution of two functions and give the correct output.</span>


<span class="sd">    Args:</span>
<span class="sd">        x1 (numpy array): independent variable of first function; must be in</span>
<span class="sd">            ascending order</span>
<span class="sd">        y1 (numpy array): dependent variable of first function</span>
<span class="sd">        x2 (numpy array): independent variable of second function; must have</span>
<span class="sd">            same grid spacing as x1</span>
<span class="sd">        y2 (numpy array): dependent variable of second function</span>

<span class="sd">    Returns:</span>
<span class="sd">        xcv (numpy array): independent variable of convoluted function, has</span>
<span class="sd">            dimension len(x1) + len(x2) - 1</span>

<span class="sd">        ycv (numpy array): convolution of y1 and y2, same shape as xcv</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ycv</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="n">xcv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ycv</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xcv</span><span class="p">,</span> <span class="n">ycv</span></div>

<div class="viewcode-block" id="costransform"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.costransform">[docs]</a><span class="k">def</span> <span class="nf">costransform</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">rstep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> <span class="c1"># does not require even q-grid</span>
    <span class="sd">&quot;&quot;&quot;Compute the cosine Fourier transform of a function.</span>

<span class="sd">    This method uses direct integration rather than an FFT and doesn&#39;t require</span>
<span class="sd">    an even grid. The grid for the Fourier transform is even and specifiable.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (numpy array): independent variable for function to be transformed</span>
<span class="sd">        fq (numpy array): dependent variable for function to be transformed</span>
<span class="sd">        rmin (float, default = 0.0): min value of conjugate independent variable</span>
<span class="sd">            grid</span>
<span class="sd">        rmax (float, default = 50.0): maximum value of conjugate independent</span>
<span class="sd">            variable grid</span>
<span class="sd">        rstep (float, default = 0.1): grid spacing for conjugate independent</span>
<span class="sd">            variable</span>

<span class="sd">    Returns:</span>
<span class="sd">        r (numpy array): independent variable grid for transformed quantity</span>

<span class="sd">        fr (numpy array): cosine Fourier transform of fq</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lostep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">rmin</span> <span class="o">-</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">/</span> <span class="n">rstep</span><span class="p">))</span>
    <span class="n">histep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">rmax</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">/</span> <span class="n">rstep</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lostep</span><span class="p">,</span> <span class="n">histep</span><span class="p">)</span><span class="o">*</span><span class="n">rstep</span>
    <span class="n">qrmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">integrand</span> <span class="o">=</span> <span class="n">fq</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">qrmat</span><span class="p">)</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">fr</span></div>


<div class="viewcode-block" id="getDiffData"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.getDiffData">[docs]</a><span class="k">def</span> <span class="nf">getDiffData</span><span class="p">(</span><span class="n">fileNames</span><span class="o">=</span><span class="p">[],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;pdfgui&#39;</span><span class="p">,</span> <span class="n">writedata</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract the fit residual from a structural PDF fit.</span>

<span class="sd">    Args:</span>
<span class="sd">        fileNames (python list): list of paths to the files containing the</span>
<span class="sd">            fit information (e.g. calculated and experimental PDF, as in the</span>
<span class="sd">            .fgr files from PDFgui exported fits)</span>
<span class="sd">        fmt (string): string identifying the format of the file(s). Options</span>
<span class="sd">            are currently just &#39;pdfgui&#39;.</span>
<span class="sd">        writedata (boolean): whether or not the output should be saved to file</span>

<span class="sd">    Returns:</span>
<span class="sd">        r (numpy array): same r-grid as contained in the fit file</span>

<span class="sd">        diff (numpy array): the structural PDF fit residual (i.e. the mPDF)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fileNames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;pdfgui&#39;</span><span class="p">:</span>
            <span class="n">allcols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">allcols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">allcols</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">writedata</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.diff&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">diff</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">diff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;This format is not currently supported.&#39;</span></div>

<div class="viewcode-block" id="calculatemPDF"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.calculatemPDF">[docs]</a><span class="k">def</span> <span class="nf">calculatemPDF</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">sxyz</span><span class="p">,</span> <span class="n">gfactors</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">calcList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="n">rstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">psigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">qmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">qmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dampRate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dampPower</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">maxextension</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                  <span class="n">orderedScale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the normalized mPDF.</span>

<span class="sd">    At minimum, this module requires input lists of atomic positions and spins.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (numpy array): list of atomic coordinates of all the magnetic</span>
<span class="sd">            atoms in the structure.</span>
<span class="sd">        sxyz (numpy array): triplets giving the spin vectors of all the</span>
<span class="sd">            atoms, in the same order as the xyz array provided as input.</span>
<span class="sd">        gfactors (numpy array): Lande g-factors of spins in same order as</span>
<span class="sd">            spin array.</span>
<span class="sd">        calcList (python list): list giving the indices of the atoms array</span>
<span class="sd">            specifying the atoms to be used as the origin when calculating</span>
<span class="sd">            the mPDF.</span>
<span class="sd">        rstep (float): step size for r-grid of calculated mPDF.</span>
<span class="sd">        rmin (float): minimum value of r for which mPDF should be calculated.</span>
<span class="sd">        rmax (float): maximum value of r for which mPDF should be calculated.</span>
<span class="sd">        psigma(float): std deviation (in Angstroms) of Gaussian peak</span>
<span class="sd">            to be convoluted with the calculated mPDF to simulate thermal</span>
<span class="sd">            motion.</span>
<span class="sd">        qmin (float): minimum experimentally accessible q-value (to be used</span>
<span class="sd">            for simulating termination ripples). If &lt;0, no termination effects</span>
<span class="sd">            are included.</span>
<span class="sd">        qmax (float): maximum experimentally accessible q-value (to be used</span>
<span class="sd">            for simulating termination ripples). If &lt;0, no termination effects</span>
<span class="sd">            are included.</span>
<span class="sd">        dampRate (float): generalized (&quot;stretched&quot;) exponential damping rate</span>
<span class="sd">                of the mPDF.</span>
<span class="sd">        dampPower (float): power of the generalized exponential function.</span>
<span class="sd">        maxextension (float): extension of the r-grid on which the mPDF is</span>
<span class="sd">            calculated to properly account for contribution of pairs just</span>
<span class="sd">            outside the boundary.</span>
<span class="sd">        ordScale (float): overall scale factor for the mPDF function f(r).</span>

<span class="sd">    Returns: numpy arrays for r and the mPDF fr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># check if g-factors have been provided</span>
    <span class="k">if</span> <span class="n">sxyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gfactors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">gfactors</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sxyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># calculate s1, s2</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="o">+</span><span class="n">maxextension</span><span class="o">+</span><span class="n">rstep</span><span class="p">,</span> <span class="n">rstep</span><span class="p">)</span>
    <span class="n">rbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r</span><span class="o">-</span><span class="n">rstep</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rstep</span><span class="o">/</span><span class="mi">2</span><span class="p">]])</span>

    <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">uu</span> <span class="ow">in</span> <span class="n">calcList</span><span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">sxyz</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="n">sxyz</span>
        <span class="n">gi</span> <span class="o">=</span> <span class="n">gfactors</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span>
        <span class="n">gj</span> <span class="o">=</span> <span class="n">gfactors</span>

        <span class="n">dxyz</span> <span class="o">=</span> <span class="n">rj</span><span class="o">-</span><span class="n">ri</span>
        <span class="n">d2xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">dxyz</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dxyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d1xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2xyz</span><span class="p">)</span>
        <span class="n">d1xyz</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="c1">### avoid divide by zero problem</span>
        <span class="n">d1xyzr</span> <span class="o">=</span> <span class="n">d1xyz</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">xh</span> <span class="o">=</span> <span class="n">dxyz</span> <span class="o">/</span> <span class="n">d1xyz</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="n">si</span> <span class="o">-</span> <span class="n">xh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si</span><span class="o">*</span><span class="n">xh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dxyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">yh_dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yh</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">yh_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yh_dis</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">yh</span><span class="p">[</span><span class="n">yh_ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">yh_dis</span><span class="p">[</span><span class="n">yh_ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="c1">### avoid divide by zero problem</span>

        <span class="n">aij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si</span> <span class="o">*</span> <span class="n">yh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sj</span> <span class="o">*</span> <span class="n">yh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">yh_dis</span>
        <span class="n">aij</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bij</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si</span> <span class="o">*</span> <span class="n">xh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sj</span> <span class="o">*</span> <span class="n">xh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">aij</span>

        <span class="n">w2</span> <span class="o">=</span> <span class="n">bij</span> <span class="o">/</span> <span class="n">d1xyzr</span><span class="o">**</span><span class="mi">3</span>

        <span class="n">d1xyzr</span><span class="p">[</span><span class="n">uu</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">s1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">d1xyzr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">rbin</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">gi</span><span class="o">*</span><span class="n">gj</span><span class="o">*</span><span class="n">aij</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">d1xyzr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">rbin</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">gi</span><span class="o">*</span><span class="n">gj</span><span class="o">*</span><span class="n">w2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># apply Gaussian shape function</span>
    <span class="k">if</span> <span class="n">psigma</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rstep</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">psigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">psigma</span><span class="p">)</span>

        <span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">s1</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">s2</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">rstep</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ss2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="o">*</span><span class="n">rstep</span> <span class="c1"># avoid infinities at r = 0</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">ss2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ss2</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmin</span>
    <span class="n">fr</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">calcList</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gfactors</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">fr</span> <span class="o">*=</span> <span class="n">orderedScale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">dampRate</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="n">dampPower</span><span class="p">)</span><span class="o">**</span><span class="n">dampPower</span><span class="p">)</span>
    <span class="c1"># Do the convolution with the termination function if qmin/qmax have been given</span>
    <span class="k">if</span> <span class="n">qmin</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">qmax</span> <span class="o">&gt;</span> <span class="n">qmin</span><span class="p">:</span>
        <span class="n">rth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">+</span><span class="n">maxextension</span><span class="o">+</span><span class="n">rstep</span><span class="p">,</span> <span class="n">rstep</span><span class="p">)</span>
        <span class="n">rth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="o">*</span><span class="n">rstep</span> <span class="c1"># avoid infinities at r = 0</span>
        <span class="n">th</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">qmax</span><span class="o">*</span><span class="n">rth</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">qmin</span><span class="o">*</span><span class="n">rth</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">rth</span>
        <span class="n">rth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">rcv</span><span class="p">,</span> <span class="n">frcv</span> <span class="o">=</span> <span class="n">cv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">rth</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rcv</span><span class="p">,</span> <span class="n">frcv</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">fr</span>

    <span class="k">return</span> <span class="n">rcv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rcv</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rstep</span><span class="p">,</span> <span class="n">rcv</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rstep</span><span class="p">)],</span> \
           <span class="n">frcv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rcv</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rstep</span><span class="p">,</span> <span class="n">rcv</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rstep</span><span class="p">)]</span></div>


<div class="viewcode-block" id="calculateDr"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.calculateDr">[docs]</a><span class="k">def</span> <span class="nf">calculateDr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">paraScale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rmintr</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rmaxtr</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                <span class="n">drtr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">qmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the unnormalized mPDF quantity D(r).</span>

<span class="sd">    This module requires a normalized mPDF as an input, as well as a magnetic</span>
<span class="sd">    form factor and associated q grid.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (numpy array): r grid for the properly normalized mPDF.</span>
<span class="sd">        fr (numpy array): the properly normalized mPDF.</span>
<span class="sd">        q (numpy array): grid of momentum transfer values used for calculating</span>
<span class="sd">            the magnetic form factor.</span>
<span class="sd">        ff (numpy array): magnetic form factor. Same shape as ffqgrid.</span>
<span class="sd">        paraScale (float): scale factor for the paramagnetic part of the</span>
<span class="sd">            unnormalized mPDF function D(r).</span>
<span class="sd">        rmintr (float): minimum value of r for the Fourier transform of the</span>
<span class="sd">            magnetic form factor required for unnormalized mPDF.</span>
<span class="sd">        rmaxtr (float): maximum value of r for the Fourier transform of the</span>
<span class="sd">            magnetic form factor required for unnormalized mPDF.</span>
<span class="sd">        drtr (float): step size for r-grid used for calculating Fourier</span>
<span class="sd">            transform of magnetic form mactor.</span>
<span class="sd">        qmin (float): minimum experimentally accessible q-value (to be used</span>
<span class="sd">            for simulating termination ripples). If &lt;0, no termination effects</span>
<span class="sd">            are included.</span>
<span class="sd">        qmax (float): maximum experimentally accessible q-value (to be used</span>
<span class="sd">            for simulating termination ripples). If &lt;0, no termination effects</span>
<span class="sd">            are included.</span>

<span class="sd">    Returns: numpy array for the unnormalized mPDF Dr.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rsr</span><span class="p">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">costransform</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">rmintr</span><span class="p">,</span> <span class="n">rmaxtr</span><span class="p">,</span> <span class="n">drtr</span><span class="p">)</span>
    <span class="n">sr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">sr</span>
    <span class="n">rSr</span><span class="p">,</span> <span class="n">Sr</span> <span class="o">=</span> <span class="n">cv</span><span class="p">(</span><span class="n">rsr</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">rsr</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
    <span class="n">para</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">Sr</span><span class="p">,</span> <span class="n">rSr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rSr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">### paramagnetic term in d(r)</span>
    <span class="n">rDr</span><span class="p">,</span> <span class="n">Dr</span> <span class="o">=</span> <span class="n">cv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">rSr</span><span class="p">,</span> <span class="n">Sr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">qmin</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">qmax</span> <span class="o">&gt;</span> <span class="n">qmin</span><span class="p">:</span>
        <span class="n">rstep</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">rstep</span><span class="p">,</span> <span class="n">rstep</span><span class="p">)</span>
        <span class="n">rth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="o">*</span><span class="n">rstep</span> <span class="c1"># avoid infinities at r = 0</span>
        <span class="n">th</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">qmax</span><span class="o">*</span><span class="n">rth</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">qmin</span><span class="o">*</span><span class="n">rth</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">rth</span>
        <span class="n">rth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">rpara</span><span class="p">,</span> <span class="n">para</span> <span class="o">=</span> <span class="n">cv</span><span class="p">(</span><span class="n">rSr</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">rth</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rpara</span><span class="p">,</span> <span class="n">para</span> <span class="o">=</span> <span class="n">rSr</span><span class="p">,</span> <span class="n">para</span>
    <span class="c1"># make sure para and Dr match up in shape</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">goodslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rDr</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dr</span><span class="p">,</span> <span class="n">rDr</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dr</span><span class="p">)</span>
    <span class="n">Dr</span> <span class="o">=</span> <span class="n">Dr</span><span class="p">[</span><span class="n">goodslice</span><span class="p">]</span>
    <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="p">[</span><span class="n">rpara</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Dr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">para</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Dr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">para</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="p">[:</span><span class="n">Dr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">Dr</span> <span class="o">+=</span> <span class="n">paraScale</span><span class="o">*</span><span class="n">para</span>
    <span class="k">return</span> <span class="n">Dr</span></div>

<div class="viewcode-block" id="mPDFcalculator"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.mPDFcalculator">[docs]</a><span class="k">class</span> <span class="nc">mPDFcalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create an mPDFcalculator object to help calculate mPDF functions.</span>

<span class="sd">    This class is loosely modelled after the PDFcalculator class in diffpy.</span>
<span class="sd">    At minimum, it requires a magnetic structure with atoms and spins, and</span>
<span class="sd">    it calculates the mPDF from that. Various other options can be specified</span>
<span class="sd">    for the calculated mPDF.</span>

<span class="sd">    Args:</span>
<span class="sd">        magstruc (magStructure object): provides information about the</span>
<span class="sd">            magnetic structure. Must have arrays of atoms and spins.</span>
<span class="sd">        calcList (python list): list giving the indices of the atoms array</span>
<span class="sd">            specifying the atoms to be used as the origin when calculating</span>
<span class="sd">            the mPDF.</span>
<span class="sd">        maxextension (float): extension of the r-grid on which the mPDF is</span>
<span class="sd">            calculated to properly account for contribution of pairs just</span>
<span class="sd">            outside the boundary.</span>
<span class="sd">        gaussPeakWidth(float): std deviation (in Angstroms) of Gaussian peak</span>
<span class="sd">            to be convoluted with the calculated mPDF to simulate thermal</span>
<span class="sd">            motion.</span>
<span class="sd">        dampRate (float): generalized (&quot;stretched&quot;) exponential damping rate</span>
<span class="sd">                of the mPDF.</span>
<span class="sd">        dampPower (float): power of the generalized exponential function.</span>
<span class="sd">        qmin (float): minimum experimentally accessible q-value (to be used</span>
<span class="sd">            for simulating termination ripples). If &lt;0, no termination effects</span>
<span class="sd">            are included.</span>
<span class="sd">        qmax (float): maximum experimentally accessible q-value (to be used</span>
<span class="sd">            for simulating termination ripples). If &lt;0, no termination effects</span>
<span class="sd">            are included.</span>
<span class="sd">        rmin (float): minimum value of r for which mPDF should be calculated.</span>
<span class="sd">        rmax (float): maximum value of r for which mPDF should be calculated.</span>
<span class="sd">        rstep (float): step size for r-grid of calculated mPDF.</span>
<span class="sd">        ordScale (float): overall scale factor for the mPDF function f(r).</span>
<span class="sd">        paraScale (float): scale factor for the paramagnetic part of the</span>
<span class="sd">            unnormalized mPDF function D(r).</span>
<span class="sd">        rmintr (float): minimum value of r for the Fourier transform of the</span>
<span class="sd">            magnetic form factor required for unnormalized mPDF.</span>
<span class="sd">        rmaxtr (float): maximum value of r for the Fourier transform of the</span>
<span class="sd">            magnetic form factor required for unnormalized mPDF.</span>
<span class="sd">        drtr (float): step size for r-grid used for calculating Fourier</span>
<span class="sd">            transform of magnetic form mactor.</span>
<span class="sd">        label (string): Optional descriptive string for the mPDFcalculator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magstruc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">calcList</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxextension</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                 <span class="n">gaussPeakWidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dampRate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dampPower</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">qmin</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">qmax</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">rstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">ordScale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">paraScale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rmintr</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span>
                 <span class="n">rmaxtr</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">magstruc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span> <span class="o">=</span> <span class="n">magstruc</span>
            <span class="k">if</span> <span class="n">magstruc</span><span class="o">.</span><span class="n">rmaxAtoms</span> <span class="o">&lt;</span> <span class="n">rmax</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Warning: Your structure may not be big enough for your&#39;</span>
                <span class="k">print</span> <span class="s1">&#39;desired calculation range.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span> <span class="o">=</span> <span class="n">calcList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span> <span class="o">=</span> <span class="n">maxextension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span> <span class="o">=</span> <span class="n">gaussPeakWidth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span> <span class="o">=</span> <span class="n">dampRate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span> <span class="o">=</span> <span class="n">dampPower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span> <span class="o">=</span> <span class="n">qmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span> <span class="o">=</span> <span class="n">qmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">rmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">=</span> <span class="n">rmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span> <span class="o">=</span> <span class="n">rstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span> <span class="o">=</span> <span class="n">ordScale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span> <span class="o">=</span> <span class="n">paraScale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmintr</span> <span class="o">=</span> <span class="n">rmintr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmaxtr</span> <span class="o">=</span> <span class="n">rmaxtr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;mPDFcalculator() object&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;: mPDFcalculator() object&#39;</span>

<div class="viewcode-block" id="mPDFcalculator.calc"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.mPDFcalculator.calc">[docs]</a>    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">both</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the magnetic PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            normalized (boolean): indicates whether or not the normalized mPDF</span>
<span class="sd">                should be returned.</span>
<span class="sd">            both (boolean): indicates whether or not both normalized and</span>
<span class="sd">                unnormalized mPDF quantities should be returned.</span>

<span class="sd">        Returns: numpy array giving the r grid of the calculation, as well as</span>
<span class="sd">            one or both the mPDF quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">normalized</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">both</span><span class="p">:</span>
            <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span> <span class="o">=</span> <span class="n">calculatemPDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">gfactors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">normalized</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">both</span><span class="p">:</span>
            <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span> <span class="o">=</span> <span class="n">calculatemPDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">gfactors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">)</span>
            <span class="n">Drcalc</span> <span class="o">=</span> <span class="n">calculateDr</span><span class="p">(</span><span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ffqgrid</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmintr</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">rmaxtr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcalc</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Drcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span> <span class="o">=</span> <span class="n">calculatemPDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">gfactors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">)</span>
            <span class="n">Drcalc</span> <span class="o">=</span> <span class="n">calculateDr</span><span class="p">(</span><span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ffqgrid</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmintr</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">rmaxtr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcalc</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">frcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Drcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

<div class="viewcode-block" id="mPDFcalculator.plot"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.mPDFcalculator.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">both</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the magnetic PDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            normalized (boolean): indicates whether or not the normalized mPDF</span>
<span class="sd">                should be plotted.</span>
<span class="sd">            both (boolean): indicates whether or not both normalized and</span>
<span class="sd">                unnormalized mPDF quantities should be plotted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;r ($\AA$)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalized</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">both</span><span class="p">:</span>
            <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span> <span class="o">=</span> <span class="n">calculatemPDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">gfactors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span><span class="p">)</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;f ($\AA^{-2}$)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">normalized</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">both</span><span class="p">:</span>
            <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span> <span class="o">=</span> <span class="n">calculatemPDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">gfactors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">)</span>
            <span class="n">Drcalc</span> <span class="o">=</span> <span class="n">calculateDr</span><span class="p">(</span><span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ffqgrid</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmintr</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">rmaxtr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcalc</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Drcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;d ($\AA^{-2}$)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span> <span class="o">=</span> <span class="n">calculatemPDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">gfactors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">gaussPeakWidth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dampRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dampPower</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">maxextension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">)</span>
            <span class="n">Drcalc</span> <span class="o">=</span> <span class="n">calculateDr</span><span class="p">(</span><span class="n">rcalc</span><span class="p">,</span> <span class="n">frcalc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ffqgrid</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmintr</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">rmaxtr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qmax</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcalc</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">frcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;f(r)&#39;</span><span class="p">)</span> <span class="c1"># extra factor makes it easier to compare</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Drcalc</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;d(r)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;f, d ($\AA^{-2}$)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="mPDFcalculator.runChecks"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.mPDFcalculator.runChecks">[docs]</a>    <span class="k">def</span> <span class="nf">runChecks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run some quick checks to help with troubleshooting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s1">&#39;Running checks on mPDFcalculator...</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">flagCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">### check if number of spins and atoms do not match</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">flagCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s1">&#39;Number of atoms and spins do not match; try calling&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;makeAtoms() and makeSpins() again on your magStructure.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">### check for nan values in spin array</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">spins</span><span class="p">)):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">flagCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s1">&#39;Spin array contains nan values (&quot;not a number&quot;).</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">### check if rmax is too big for rmaxAtoms in structure</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">rmaxAtoms</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">flagCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s1">&#39;Warning: the atoms in your magStructure may not fill a&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;volume large enough for the desired rmax for the mPDF&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;calculation. Adjust rmax and/or rmaxAtoms in the&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;magSpecies or magStructure objects.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">### check if calcList may not be representative of all magSpecies.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">flagCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s1">&#39;Warning: your calcList may not be representative of all&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;the magnetic species. calcList should have the index of&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;at least one spin from each species. Use&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;magStruc.getSpeciesIdxs() to see starting indices for&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;each species.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">### check if calcList has indices that exceed the spin array</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcList</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">magstruc</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">flagCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s1">&#39;calcList contains indices that are too large for the&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;arrays of atoms and spins contained in the magStructure.&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">### check for unphysical parameters like negative scale factors</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">flagCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s1">&#39;Warning: you have a negative scale factor.&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;Paramagnetic scale = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paraScale</span>
            <span class="k">print</span> <span class="s1">&#39;Ordered scale = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordScale</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">flagCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;All checks passed. No obvious problems found.</span><span class="se">\n</span><span class="s1">&#39;</span></div>

<div class="viewcode-block" id="mPDFcalculator.rgrid"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.mPDFcalculator.rgrid">[docs]</a>    <span class="k">def</span> <span class="nf">rgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current r grid of the mPDF calculator.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span><span class="p">)</span></div>

<div class="viewcode-block" id="mPDFcalculator.copy"><a class="viewcode-back" href="../../../source/diffpy.mpdf.html#diffpy.mpdf.mpdfcalculator.mPDFcalculator.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a deep copy of the mPDFcalculator object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Benjamin Frandsen and Simon Billinge.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>